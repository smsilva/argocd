apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: teams.mongodbatlas.silvios.me
spec:
  compositeTypeRef:
    apiVersion: mongodbatlas.silvios.me/v1alpha1
    kind: Team
  resources:
    - name: stack_instance_object
      base: 
        apiVersion: kubernetes.crossplane.io/v1alpha1
        kind: Object
        spec:
          forProvider:
            manifest:
              apiVersion: terraform.silvios.me/v1alpha1
              kind: StackInstance
              metadata:
                name: mongodbatlas-team-1
                namespace: default
              spec:
                stack:
                  provider: mongodbatlas
                  backend: azurerm
                  registry: beesterraform.azurecr.io
                  image: mongodbatlas-mongodb-team
                  version: 0.1.1
                vars:
                  organization_id: ORG_ID
                  team_name: TEAM_NAME
                  team_usernames:
                    - foo@bar.com
                outputs:
                  - atlas_team

      patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: spec.forProvider.manifest.metadata.name

        - type: FromCompositeFieldPath
          fromFieldPath: spec.organizationId
          toFieldPath: spec.forProvider.manifest.spec.vars.organization_id
        
        - type: FromCompositeFieldPath
          fromFieldPath: spec.team.name
          toFieldPath: spec.forProvider.manifest.spec.vars.team_name

        - type: FromCompositeFieldPath
          fromFieldPath: spec.team.users
          toFieldPath: spec.forProvider.manifest.spec.vars.team_usernames
